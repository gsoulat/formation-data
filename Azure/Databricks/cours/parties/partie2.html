<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partie 2 : Configuration et Workspace</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öôÔ∏è Partie 2 : Configuration et Workspace</h1>
            <p class="subtitle">Cr√©ez et configurez votre workspace Databricks</p>
            <span class="duration">‚è±Ô∏è Dur√©e : 40 minutes</span>
        </header>

        <nav class="nav-menu">
            <ul>
                <li><a href="../index.html">üè† Accueil</a></li>
                <li><a href="partie1.html">‚Üê Partie 1</a></li>
                <li><a href="partie2.html" class="active">Partie 2</a></li>
                <li><a href="partie3.html">Partie 3 ‚Üí</a></li>
            </ul>
        </nav>

        <div class="content">
            <section class="objectives">
                <h2>üéØ Objectifs d'apprentissage</h2>
                <ul>
                    <li>Cr√©er un workspace Azure Databricks</li>
                    <li>Comprendre les diff√©rentes options de configuration</li>
                    <li>Configurer la s√©curit√© r√©seau et les acc√®s</li>
                    <li>Cr√©er et g√©rer des clusters Spark</li>
                    <li>Optimiser les co√ªts avec autoscaling et terminaison automatique</li>
                </ul>
            </section>

            <section class="section">
                <h2>1. Cr√©ation d'un workspace Databricks</h2>

                <h3>Pr√©requis</h3>
                <ul>
                    <li>Un abonnement Azure actif</li>
                    <li>Les permissions pour cr√©er des ressources (Contributor ou Owner)</li>
                    <li>Un groupe de ressources Azure</li>
                </ul>

                <h3>√âtapes de cr√©ation via le portail Azure</h3>

                <div class="exercise">
                    <h4>Cr√©ation d'un workspace</h4>
                    <ol>
                        <li><strong>Acc√©dez au portail Azure</strong> (portal.azure.com)</li>
                        <li>Cliquez sur <code>+ Cr√©er une ressource</code></li>
                        <li>Recherchez "Azure Databricks"</li>
                        <li>Cliquez sur <code>Cr√©er</code></li>
                        <li>Remplissez les informations de base :
                            <ul>
                                <li><strong>Abonnement :</strong> S√©lectionnez votre abonnement</li>
                                <li><strong>Groupe de ressources :</strong> Cr√©ez ou s√©lectionnez un groupe existant</li>
                                <li><strong>Nom du workspace :</strong> Par exemple "databricks-prod-workspace"</li>
                                <li><strong>R√©gion :</strong> Choisissez une r√©gion proche de vos donn√©es (ex: West Europe)</li>
                                <li><strong>Niveau tarifaire :</strong> Standard, Premium ou Trial</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3>Niveaux tarifaires</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Niveau</th>
                            <th>Fonctionnalit√©s</th>
                            <th>Cas d'usage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Trial</strong></td>
                            <td>
                                ‚Ä¢ 14 jours gratuits<br>
                                ‚Ä¢ Fonctionnalit√©s Premium<br>
                                ‚Ä¢ Limit√© en ressources
                            </td>
                            <td>Tests et POC</td>
                        </tr>
                        <tr>
                            <td><strong>Standard</strong></td>
                            <td>
                                ‚Ä¢ Clusters Spark<br>
                                ‚Ä¢ Notebooks<br>
                                ‚Ä¢ Jobs scheduling<br>
                                ‚Ä¢ RBAC basique
                            </td>
                            <td>Data Engineering de base</td>
                        </tr>
                        <tr>
                            <td><strong>Premium</strong></td>
                            <td>
                                ‚Ä¢ Tout du Standard +<br>
                                ‚Ä¢ RBAC avanc√©<br>
                                ‚Ä¢ Azure AD int√©gration<br>
                                ‚Ä¢ Audit logs<br>
                                ‚Ä¢ Secrets management
                            </td>
                            <td>Production enterprise</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-info">
                    <h4>Recommandation</h4>
                    <p>Pour un usage en production, choisissez toujours le niveau <strong>Premium</strong> qui offre des fonctionnalit√©s de s√©curit√© et gouvernance essentielles.</p>
                </div>
            </section>

            <section class="section">
                <h2>2. Configuration r√©seau et s√©curit√©</h2>

                <h3>Options de d√©ploiement r√©seau</h3>

                <div class="grid">
                    <div class="grid-item">
                        <h4>D√©ploiement standard</h4>
                        <p><strong>VNet manag√© par Databricks</strong></p>
                        <ul>
                            <li>Configuration automatique</li>
                            <li>Rapide √† d√©ployer</li>
                            <li>Moins de contr√¥le</li>
                        </ul>
                    </div>
                    <div class="grid-item">
                        <h4>VNet Injection</h4>
                        <p><strong>Votre propre VNet Azure</strong></p>
                        <ul>
                            <li>Contr√¥le total du r√©seau</li>
                            <li>Int√©gration avec infrastructure existante</li>
                            <li>Configuration NSG personnalis√©e</li>
                        </ul>
                    </div>
                </div>

                <h3>Configuration VNet Injection</h3>
                <div class="exercise">
                    <h4>Pr√©requis pour VNet Injection</h4>
                    <ol>
                        <li><strong>Cr√©er un VNet avec au moins 2 subnets via le portail Azure :</strong>
                            <ul>
                                <li><strong>Subnet priv√© pour les workers :</strong> minimum /26 (ex: 10.0.1.0/26)</li>
                                <li><strong>Subnet public pour le control plane :</strong> minimum /26 (ex: 10.0.2.0/26)</li>
                            </ul>
                        </li>
                        <li><strong>D√©l√©guer les subnets √† Databricks :</strong>
                            <ul>
                                <li>Dans chaque subnet, aller dans "D√©l√©gations de service"</li>
                                <li>S√©lectionner "Microsoft.Databricks/workspaces"</li>
                            </ul>
                        </li>
                        <li><strong>Lors de la cr√©ation du workspace Databricks :</strong>
                            <ul>
                                <li>Cocher "D√©ployer Azure Databricks dans votre r√©seau virtuel"</li>
                                <li>S√©lectionner le VNet et les subnets cr√©√©s</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="alert alert-warning">
                    <h4>Important : Taille des subnets</h4>
                    <p>Chaque subnet doit avoir au moins un pr√©fixe /26 (64 adresses) pour permettre la cr√©ation de clusters. Pour les environnements de production, utilisez au minimum /24.</p>
                </div>

                <h3>S√©curit√© avec Azure AD</h3>
                <div class="alert alert-info">
                    <h4>Configuration de l'authentification</h4>
                    <p>En niveau Premium, l'authentification Azure AD est activ√©e automatiquement. Les utilisateurs se connectent avec leurs identifiants Azure AD existants.</p>
                    <p>L'attribution des r√¥les et permissions se fait via le portail Azure dans la section "Contr√¥le d'acc√®s (IAM)" de votre workspace Databricks.</p>
                </div>
            </section>

            <section class="section">
                <h2>3. Gestion des clusters</h2>

                <h3>Types de clusters</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Cas d'usage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>All-Purpose Cluster</strong></td>
                            <td>
                                ‚Ä¢ Cluster interactif<br>
                                ‚Ä¢ Partag√© entre utilisateurs<br>
                                ‚Ä¢ Persiste entre ex√©cutions
                            </td>
                            <td>
                                ‚Ä¢ D√©veloppement<br>
                                ‚Ä¢ Exploration de donn√©es<br>
                                ‚Ä¢ Notebooks interactifs
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Job Cluster</strong></td>
                            <td>
                                ‚Ä¢ Cr√©√© automatiquement<br>
                                ‚Ä¢ Termin√© apr√®s le job<br>
                                ‚Ä¢ Optimis√© pour une t√¢che
                            </td>
                            <td>
                                ‚Ä¢ Jobs automatis√©s<br>
                                ‚Ä¢ Pipelines de production<br>
                                ‚Ä¢ Optimisation des co√ªts
                            </td>
                        </tr>
                    </tbody>
                </table>

                <h3>Cr√©ation d'un cluster via l'interface</h3>
                <div class="exercise">
                    <h4>Cr√©er un cluster All-Purpose</h4>
                    <ol>
                        <li>Dans votre workspace, cliquez sur <code>Compute</code> dans la barre lat√©rale</li>
                        <li>Cliquez sur <code>Create Cluster</code></li>
                        <li>Configurez :
                            <ul>
                                <li><strong>Cluster name :</strong> "dev-cluster"</li>
                                <li><strong>Cluster mode :</strong> Standard</li>
                                <li><strong>Databricks Runtime Version :</strong> 13.3 LTS (ou plus r√©cent)</li>
                                <li><strong>Node type :</strong> Standard_DS3_v2 (ou selon vos besoins)</li>
                                <li><strong>Workers :</strong> Min 2, Max 8 (avec autoscaling)</li>
                                <li><strong>Auto Termination :</strong> 20 minutes</li>
                            </ul>
                        </li>
                        <li>Cliquez sur <code>Create Cluster</code></li>
                    </ol>
                </div>

                <h3>Configuration via l'API Databricks</h3>
                <pre><code class="language-python"># Cr√©ation de cluster via l'API Databricks
import requests
import json

DATABRICKS_HOST = "https://&lt;workspace-url&gt;"
DATABRICKS_TOKEN = "&lt;your-token&gt;"

cluster_config = {
    "cluster_name": "production-cluster",
    "spark_version": "13.3.x-scala2.12",
    "node_type_id": "Standard_DS3_v2",
    "num_workers": 2,
    "autoscale": {
        "min_workers": 2,
        "max_workers": 8
    },
    "auto_termination_minutes": 30,
    "enable_elastic_disk": True,
    "cluster_source": "API"
}

headers = {
    "Authorization": f"Bearer {DATABRICKS_TOKEN}",
    "Content-Type": "application/json"
}

response = requests.post(
    f"{DATABRICKS_HOST}/api/2.0/clusters/create",
    headers=headers,
    json=cluster_config
)

cluster_id = response.json()["cluster_id"]
print(f"Cluster cr√©√© avec l'ID : {cluster_id}")
</code></pre>
            </section>

            <section class="section">
                <h2>4. Configurations de cluster avanc√©es</h2>

                <h3>Types de VMs recommand√©s</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Workload</th>
                            <th>VM Type</th>
                            <th>Caract√©ristiques</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Data Engineering g√©n√©ral</td>
                            <td>Standard_DS3_v2</td>
                            <td>4 vCPU, 14 GB RAM - √âquilibr√©</td>
                        </tr>
                        <tr>
                            <td>Calcul intensif</td>
                            <td>Standard_F8s_v2</td>
                            <td>8 vCPU, 16 GB RAM - Optimis√© CPU</td>
                        </tr>
                        <tr>
                            <td>Machine Learning</td>
                            <td>Standard_NC6s_v3</td>
                            <td>6 vCPU, GPU V100 - Acc√©l√©ration GPU</td>
                        </tr>
                        <tr>
                            <td>M√©moire intensive</td>
                            <td>Standard_E8s_v3</td>
                            <td>8 vCPU, 64 GB RAM - Haute m√©moire</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Spark Configuration</h3>
                <pre><code class="language-python"># Configuration Spark personnalis√©e dans le cluster
spark_conf = {
    "spark.sql.adaptive.enabled": "true",
    "spark.sql.adaptive.coalescePartitions.enabled": "true",
    "spark.databricks.delta.preview.enabled": "true",
    "spark.sql.shuffle.partitions": "auto"
}

# Variables d'environnement
env_vars = {
    "PYSPARK_PYTHON": "/databricks/python3/bin/python3",
    "ENV": "production"
}

# Init Scripts pour installer des d√©pendances
init_scripts = [{
    "dbfs": {
        "destination": "dbfs:/databricks/init-scripts/install-libs.sh"
    }
}]
</code></pre>

                <h3>Autoscaling</h3>
                <p>L'autoscaling permet d'ajuster automatiquement le nombre de workers en fonction de la charge :</p>

                <div class="grid">
                    <div class="grid-item">
                        <h4>Avantages</h4>
                        <ul>
                            <li>Optimisation automatique des co√ªts</li>
                            <li>Performance adapt√©e √† la charge</li>
                            <li>Pas de sur-provisionnement</li>
                        </ul>
                    </div>
                    <div class="grid-item">
                        <h4>Configuration recommand√©e</h4>
                        <ul>
                            <li>Min workers : 2 (haute disponibilit√©)</li>
                            <li>Max workers : 8-16 (selon budget)</li>
                            <li>Scale down : 10 minutes d'inactivit√©</li>
                        </ul>
                    </div>
                </div>

                <pre><code class="language-json">{
  "autoscale": {
    "min_workers": 2,
    "max_workers": 10
  },
  "auto_termination_minutes": 30
}
</code></pre>
            </section>

            <section class="section">
                <h2>5. Optimisation des co√ªts</h2>

                <h3>Strat√©gies d'optimisation</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Strat√©gie</th>
                            <th>Description</th>
                            <th>√âconomies potentielles</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Auto-termination</strong></td>
                            <td>Arr√™ter les clusters inactifs automatiquement</td>
                            <td>30-50% sur clusters de dev</td>
                        </tr>
                        <tr>
                            <td><strong>Job Clusters</strong></td>
                            <td>Utiliser des job clusters au lieu d'all-purpose</td>
                            <td>20-40% sur workloads batch</td>
                        </tr>
                        <tr>
                            <td><strong>Instance Pools</strong></td>
                            <td>R√©utiliser des VMs pr√©-provisionn√©es</td>
                            <td>D√©marrage 4x plus rapide</td>
                        </tr>
                        <tr>
                            <td><strong>Spot VMs</strong></td>
                            <td>Utiliser des VMs Azure Spot pour workers</td>
                            <td>60-80% sur co√ªt compute</td>
                        </tr>
                        <tr>
                            <td><strong>Photon Engine</strong></td>
                            <td>Moteur vectoris√© C++ (Premium tier)</td>
                            <td>Performances 2-4x meilleures</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-success">
                    <h4>Bonnes pratiques de co√ªts</h4>
                    <ul>
                        <li>Toujours activer l'auto-termination (recommand√© : 20-30 minutes)</li>
                        <li>Utiliser des job clusters pour les pipelines de production</li>
                        <li>Dimensionner les clusters en fonction de la charge r√©elle</li>
                        <li>Monitorer l'utilisation avec Azure Cost Management</li>
                        <li>Utiliser des tags pour tracker les co√ªts par projet/√©quipe</li>
                    </ul>
                </div>

                <h3>Configuration Spot VMs</h3>
                <pre><code class="language-python"># Configuration de cluster avec Spot VMs pour les workers
cluster_config_spot = {
    "cluster_name": "spot-cluster",
    "spark_version": "13.3.x-scala2.12",
    "node_type_id": "Standard_DS3_v2",
    "driver_node_type_id": "Standard_DS3_v2",  # Driver on-demand
    "num_workers": 4,
    "autoscale": {
        "min_workers": 2,
        "max_workers": 10
    },
    "azure_attributes": {
        "availability": "SPOT_WITH_FALLBACK_AZURE",  # Spot avec fallback on-demand
        "first_on_demand": 1,  # Driver toujours on-demand
        "spot_bid_max_price": -1  # Prix max = prix on-demand
    }
}
</code></pre>
            </section>

            <section class="section">
                <div class="key-points">
                    <h3>üìå Points cl√©s √† retenir</h3>
                    <ul>
                        <li>Choisissez Premium tier pour la production (s√©curit√© et gouvernance)</li>
                        <li>VNet Injection offre un contr√¥le r√©seau complet</li>
                        <li>All-Purpose clusters pour le dev, Job clusters pour la production</li>
                        <li>Activez toujours l'autoscaling et auto-termination</li>
                        <li>Utilisez Spot VMs pour r√©duire les co√ªts de 60-80%</li>
                        <li>Dimensionnez vos clusters selon la charge r√©elle</li>
                    </ul>
                </div>
            </section>

            <div class="alert alert-warning">
                <h4>Prochaine √©tape</h4>
                <p>Votre workspace est configur√© ! Dans la <strong>Partie 3</strong>, vous allez cr√©er votre premier notebook et d√©couvrir les diff√©rents langages support√©s.</p>
            </div>
        </div>

        <nav class="nav-menu">
            <ul>
                <li><a href="../index.html">üè† Accueil</a></li>
                <li><a href="partie1.html">‚Üê Partie 1</a></li>
                <li><a href="partie2.html" class="active">Partie 2</a></li>
                <li><a href="partie3.html">Partie 3 : Notebooks ‚Üí</a></li>
            </ul>
        </nav>

        <footer>
            <p>&copy; 2024 Formation Simplon - Azure Databricks</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
</body>
</html>
