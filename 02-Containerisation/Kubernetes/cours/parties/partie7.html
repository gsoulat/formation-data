<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partie 7 - Volumes et persistence des donn√©es</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìñ Partie 7</h1>
            <p class="subtitle">Volumes et persistence des donn√©es</p>
            <span class="duration">‚è±Ô∏è Dur√©e : 20 minutes</span>
        </header>

        <nav class="nav-menu">
            <ul>
                <li><a href="../index.html">üè† Accueil</a></li>
                <li><a href="partie1.html">Partie 1</a></li>
                <li><a href="partie2.html">Partie 2</a></li>
                <li><a href="partie3.html">Partie 3</a></li>
                <li><a href="partie4.html">Partie 4</a></li>
                <li><a href="partie5.html">Partie 5</a></li>
                <li><a href="partie6.html">Partie 6</a></li>
                <li><a href="partie7.html">Partie 7</a></li>
                <li><a href="partie8.html">Partie 8</a></li>
                <li><a href="partie9.html">Partie 9</a></li>
            </ul>
        </nav>

        <div class="content">
            <section class="section">
                <h2>7. Volumes et persistence des donn√©es</h2>

                <h3>Types de Volumes</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Cas d'usage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>emptyDir</strong></td>
                            <td>Volume temporaire, supprim√© avec le Pod</td>
                            <td>Cache, donn√©es temporaires</td>
                        </tr>
                        <tr>
                            <td><strong>hostPath</strong></td>
                            <td>Monte un r√©pertoire du Node</td>
                            <td>Dev, logs syst√®me</td>
                        </tr>
                        <tr>
                            <td><strong>PersistentVolume</strong></td>
                            <td>Stockage persistant (NFS, cloud storage)</td>
                            <td>Bases de donn√©es, fichiers persistants</td>
                        </tr>
                        <tr>
                            <td><strong>ConfigMap/Secret</strong></td>
                            <td>Monte des configs ou secrets</td>
                            <td>Configuration, credentials</td>
                        </tr>
                    </tbody>
                </table>

                <h3>emptyDir</h3>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: shared-volume-pod
spec:
  containers:
  - name: writer
    image: busybox
    command: ["sh", "-c", "while true; do date >> /data/log.txt; sleep 5; done"]
    volumeMounts:
    - name: shared-data
      mountPath: /data

  - name: reader
    image: busybox
    command: ["sh", "-c", "while true; do cat /data/log.txt; sleep 10; done"]
    volumeMounts:
    - name: shared-data
      mountPath: /data

  volumes:
  - name: shared-data
    emptyDir: {}</code></pre>
                </div>

                <h3>PersistentVolume (PV) et PersistentVolumeClaim (PVC)</h3>

                <p>
                    <strong>PersistentVolume (PV)</strong> : Stockage provisionn√© par l'admin<br>
                    <strong>PersistentVolumeClaim (PVC)</strong> : Demande de stockage par un utilisateur
                </p>

                <h4>PersistentVolume</h4>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-storage
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce  # RWO = un seul Node, RWX = plusieurs Nodes
  persistentVolumeReclaimPolicy: Retain  # ou Delete
  storageClassName: manual
  hostPath:
    path: "/mnt/data"  # Pour dev (hostPath), en prod utiliser NFS ou cloud storage</code></pre>
                </div>

                <h4>PersistentVolumeClaim</h4>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-storage
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: manual</code></pre>
                </div>

                <h4>Utiliser un PVC dans un Pod</h4>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: postgres-pod
spec:
  containers:
  - name: postgres
    image: postgres:15
    env:
    - name: POSTGRES_PASSWORD
      value: mysecretpassword
    volumeMounts:
    - name: postgres-storage
      mountPath: /var/lib/postgresql/data

  volumes:
  - name: postgres-storage
    persistentVolumeClaim:
      claimName: pvc-storage</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-bash"># Cr√©er les ressources
kubectl apply -f pv.yaml
kubectl apply -f pvc.yaml
kubectl apply -f pod-with-pvc.yaml

# V√©rifier
kubectl get pv
kubectl get pvc
kubectl describe pvc pvc-storage

# Le PVC est automatiquement li√© au PV disponible</code></pre>
                </div>

                <h3>StorageClass (provisionnement dynamique)</h3>

                <p>
                    Les <strong>StorageClass</strong> permettent le provisionnement dynamique de volumes sans cr√©er de PV manuellement.
                </p>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-yaml">apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azure-disk
provisioner: kubernetes.io/azure-disk
parameters:
  storageaccounttype: Standard_LRS
  kind: Managed</code></pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dynamic-pvc
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: azure-disk  # Utilise la StorageClass
  resources:
    requests:
      storage: 10Gi</code></pre>
                </div>

                <div class="alert alert-info">
                    <h4>Provisionnement automatique</h4>
                    <p>
                        Avec une StorageClass, Kubernetes cr√©e automatiquement le PV et le disque dans le cloud
                        quand vous cr√©ez un PVC. Tr√®s pratique en production !
                    </p>
                </div>
            </section>

            <div class="key-points">
                <h3>Points cl√©s √† retenir</h3>
                <ul>
                    <li>emptyDir pour le stockage temporaire (supprim√© avec le Pod)</li>
                    <li>PersistentVolume (PV) pour le stockage persistant provisionn√© par l'admin</li>
                    <li>PersistentVolumeClaim (PVC) pour demander du stockage</li>
                    <li>StorageClass permet le provisionnement dynamique automatique</li>
                    <li>En production cloud, utilisez toujours StorageClass</li>
                </ul>
            </div>

            <nav class="section-nav" style="display: flex; justify-content: space-between; margin-top: 40px;">
                <a href="partie6.html" style="display: inline-block; padding: 12px 25px; background: #6c757d; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                    ‚Üê Partie 6
                </a>
                <a href="partie8.html" style="display: inline-block; padding: 12px 25px; background: #0066cc; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                    Partie 8 ‚Üí
                </a>
            </nav>
        </div>

        <footer>
            <p>Formation Kubernetes pour Data Engineering - 2024</p>
            <p><a href="../index.html">‚Üê Retour √† l'accueil</a></p>
        </footer>
    </div>

    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
</body>
</html>
