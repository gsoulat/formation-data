<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partie 4 : Cr√©er des Images avec Dockerfile - Formation Docker</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="../assets/styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>üìù Partie 4 : Cr√©er des Images avec Dockerfile</h1>
            <p class="subtitle">Dockerfile, multi-stage builds et bonnes pratiques</p>
            <span class="duration">‚è±Ô∏è Dur√©e : 10 minutes</span>
        </header>

        <!-- Navigation -->
        <nav class="nav-menu">
            <ul>
                <li><a href="../index.html">üè† Accueil</a></li>
                <li><a href="partie1.html">Partie 1</a></li>
                <li><a href="partie2.html">Partie 2</a></li>
                <li><a href="partie3.html">Partie 3</a></li>
                <li><a href="partie4.html" class="active">Partie 4</a></li>
                <li><a href="partie5.html">Partie 5</a></li>
                <li><a href="partie6.html">Partie 6</a></li>
                <li><a href="partie7.html">Partie 7</a></li>
            </ul>
        </nav>

        <div class="content">
            <div class="objectives">
                <h2>Objectifs de cette partie</h2>
                <ul>
                    <li>Comprendre la structure d'un Dockerfile</li>
                    <li>Ma√Ætriser les instructions essentielles</li>
                    <li>Construire des images optimis√©es</li>
                    <li>Utiliser les multi-stage builds</li>
                    <li>Appliquer les bonnes pratiques de s√©curit√©</li>
                </ul>
            </div>

            <section class="section">
                <h2>4.1 Structure d'un Dockerfile</h2>

                <div class="example">
                    <h4>üíº Exemple : Application ETL Python pour Data Engineering</h4>
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <pre><code class="language-dockerfile"># ============================================
# √âTAPE 1: Image de base
# ============================================
FROM python:3.11-slim

# M√©tadonn√©es de l'image
LABEL maintainer="votre@email.com"
LABEL version="1.0"
LABEL description="Pipeline ETL pour Data Engineering"

# ============================================
# √âTAPE 2: Configuration de l'environnement
# ============================================

# Variables d'environnement
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    APP_HOME=/app \
    DATA_DIR=/data

# D√©finir le r√©pertoire de travail
WORKDIR $APP_HOME

# ============================================
# √âTAPE 3: Installation des d√©pendances
# ============================================

# Installer les d√©pendances syst√®me
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Copier requirements.txt d'abord (cache Docker)
COPY requirements.txt .

# Installer les d√©pendances Python
RUN pip install --no-cache-dir -r requirements.txt

# ============================================
# √âTAPE 4: Copie du code source
# ============================================

# Copier le code de l'application
COPY src/ ./src/
COPY config/ ./config/
COPY etl_pipeline.py .

# ============================================
# √âTAPE 5: Configuration finale
# ============================================

# Cr√©er les r√©pertoires n√©cessaires
RUN mkdir -p $DATA_DIR/raw $DATA_DIR/processed logs

# Cr√©er un utilisateur non-root
RUN useradd -m -u 1000 dataeng && \
    chown -R dataeng:dataeng $APP_HOME $DATA_DIR

# Changer d'utilisateur
USER dataeng

# Exposer un port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s \
    CMD python -c "import sys; sys.exit(0)"

# Point de montage pour les volumes
VOLUME ["$DATA_DIR", "/app/logs"]

# Commande par d√©faut
CMD ["python", "etl_pipeline.py"]</code></pre>
                    </div>
                </div>

                <h2>4.2 Instructions Dockerfile</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Instruction</th>
                            <th>Description</th>
                            <th>Exemple</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>FROM</code></td>
                            <td>Image de base</td>
                            <td><code>FROM python:3.11-slim</code></td>
                        </tr>
                        <tr>
                            <td><code>WORKDIR</code></td>
                            <td>R√©pertoire de travail</td>
                            <td><code>WORKDIR /app</code></td>
                        </tr>
                        <tr>
                            <td><code>COPY</code></td>
                            <td>Copier des fichiers</td>
                            <td><code>COPY app.py /app/</code></td>
                        </tr>
                        <tr>
                            <td><code>RUN</code></td>
                            <td>Ex√©cuter commande au build</td>
                            <td><code>RUN pip install pandas</code></td>
                        </tr>
                        <tr>
                            <td><code>CMD</code></td>
                            <td>Commande par d√©faut</td>
                            <td><code>CMD ["python", "app.py"]</code></td>
                        </tr>
                        <tr>
                            <td><code>ENV</code></td>
                            <td>Variable d'environnement</td>
                            <td><code>ENV DB_HOST=localhost</code></td>
                        </tr>
                        <tr>
                            <td><code>EXPOSE</code></td>
                            <td>Documenter les ports</td>
                            <td><code>EXPOSE 8000</code></td>
                        </tr>
                        <tr>
                            <td><code>VOLUME</code></td>
                            <td>Point de montage</td>
                            <td><code>VOLUME /data</code></td>
                        </tr>
                        <tr>
                            <td><code>USER</code></td>
                            <td>Changer d'utilisateur</td>
                            <td><code>USER dataeng</code></td>
                        </tr>
                    </tbody>
                </table>

                <h2>4.3 Construire une Image</h2>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <pre><code class="language-bash"># Build basique
docker build -t mon-app:v1 .

# Build avec tag multiple
docker build -t mon-app:v1 -t mon-app:latest .

# Build depuis un Dockerfile sp√©cifique
docker build -f Dockerfile.dev -t mon-app:dev .

# Build avec arguments
docker build --build-arg PYTHON_VERSION=3.11 -t mon-app:v1 .

# Build sans cache
docker build --no-cache -t mon-app:v1 .</code></pre>
                </div>

                <h2>4.4 Multi-Stage Builds (Avanc√©)</h2>

                <div class="concept">
                    <p>Les <strong>multi-stage builds</strong> permettent de cr√©er des images optimis√©es en s√©parant la
                        compilation de l'ex√©cution.</p>
                </div>

                <div class="example">
                    <h4>üöÄ Exemple : Image Optimis√©e</h4>
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <pre><code class="language-dockerfile"># ============================================
# STAGE 1: Builder
# ============================================
FROM python:3.11 AS builder

WORKDIR /build

# Installer les d√©pendances de build
RUN apt-get update && apt-get install -y gcc g++ make

# Copier et installer les d√©pendances
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# ============================================
# STAGE 2: Runner (image finale l√©g√®re)
# ============================================
FROM python:3.11-slim

WORKDIR /app

# Copier uniquement les d√©pendances depuis le builder
COPY --from=builder /root/.local /root/.local

# Copier le code applicatif
COPY etl_pipeline.py .

# Ajouter les binaires au PATH
ENV PATH=/root/.local/bin:$PATH

# Utilisateur non-root
RUN useradd -m dataeng
USER dataeng

CMD ["python", "etl_pipeline.py"]

# R√©sultat : Image 3x plus l√©g√®re !</code></pre>
                    </div>
                </div>

                <div class="important">
                    <strong>üìå Bonnes Pratiques Dockerfile :</strong>
                    <ul>
                        <li>‚úÖ Utilisez des images de base officielles et sp√©cifiques</li>
                        <li>‚úÖ Copiez <code>requirements.txt</code> avant le code (cache)</li>
                        <li>‚úÖ Regroupez les commandes RUN pour minimiser les layers</li>
                        <li>‚úÖ Nettoyez les caches dans le m√™me RUN</li>
                        <li>‚úÖ N'ex√©cutez jamais en root (utilisez USER)</li>
                        <li>‚úÖ Utilisez .dockerignore</li>
                        <li>‚úÖ Ajoutez des HEALTHCHECK</li>
                        <li>‚ùå Ne stockez jamais de secrets dans l'image</li>
                    </ul>
                </div>
            </section>

            <div class="key-points">
                <h3>üí° Points cl√©s √† retenir</h3>
                <ul>
                    <li>Un Dockerfile d√©crit les instructions pour construire une image</li>
                    <li>Chaque instruction cr√©e une nouvelle couche</li>
                    <li>Copiez les fichiers de d√©pendances avant le code pour optimiser le cache</li>
                    <li>Les multi-stage builds r√©duisent drastiquement la taille des images</li>
                    <li>N'ex√©cutez jamais vos conteneurs en root pour la s√©curit√©</li>
                </ul>
            </div>

            <div class="alert alert-info">
                <h4>Prochaine √©tape</h4>
                <p>
                    Vous savez maintenant cr√©er vos propres images ! Passons √† la <strong>Partie 5</strong> pour g√©rer
                    les volumes, r√©seaux et variables d'environnement.
                </p>
            </div>

            <!-- Navigation bas de page -->
            <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                <a href="partie3.html"
                    style="display: inline-block; padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 8px; font-weight: 500;">
                    ‚Üê Partie 3 : Images et Conteneurs
                </a>
                <a href="partie5.html"
                    style="display: inline-block; padding: 12px 24px; background: #0066cc; color: white; text-decoration: none; border-radius: 8px; font-weight: 500;">
                    Partie 5 : Volumes et R√©seaux ‚Üí
                </a>
            </div>
        </div>

        <footer>
            <p>Formation Docker pour Data Engineering - 2024</p>
        </footer>
    </div>

    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-docker.min.js"></script>
</body>

</html>
